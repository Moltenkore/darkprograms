--Title: Dark Relay
Version = 3.1
--Author: Darkrising (minecraft name djhannz)
--Platform: ComputerCraft Lua Virtual Machine
AutoUpdate = true
if fs.exists("dark") == false then -- load darkAPI
  print("Missing DarkAPI")
  sleep(2)
  print("Attempting to download...")
  getGit = http.get("https://github.com/darkrising/darkprograms/raw/darkprograms/darksecurity/dark")
  getGit = getGit.readAll()
  file = fs.open("dark", "w")
  file.write(getGit)
  file.close()
  os.reboot()
else
  os.loadAPI("dark")
end
function Header(text)
  dark.printL("-", 1)
  dark.printC(text, 2)
  dark.printL("-", 3, 4)
end
-- main program
function relay()
term.clear()
term.setCursorPos(1,1)
print("Running relay.")
  while true do
    T, S, M = os.pullEvent("rednet_message")
    print("PC "..S.." Message Relayed.")     
    rednet.send(server, M)
    os.startTimer(4)
    T2, S2, M2 = os.pullEvent()
    if (T2 == "timer") then
      print("No response from server!")
    else
      if (S2 == server) then
        print("Server "..S2..": Responded")   
        rednet.send(S, M2)
      end
    end
  end
end

S = dark.findPeripheral("modem")
if S == false then
  print("Please attach Modem") 
  return exit
else
  rednet.open(S)  
end
function stealthUpdate()
  if AutoUpdate == true then 
    if ((dark.gitUpdate("relay", shell.getRunningProgram(), Version) == true) or (dark.gitUpdate("dark", "dark", dark.DARKversion) == true)) then
      os.reboot()
    end
  end
end
if fs.exists("DarkR_conf") == false then
  term.clear()
  term.setCursorPos(1,1)
  Header("Dark Relay Setup")
  write("Please type the server / relay id: ")
  ServerID = io.read()
  local file = io.open("DarkR_conf","w")
  file:write("server = "..ServerID)
  file:close()
  print("\nsetup complete! Restarting...")
  sleep(1.5)
  os.reboot()
else
  dofile("DarkR_conf")
  parallel.waitForAll(relay, stealthUpdate)
end