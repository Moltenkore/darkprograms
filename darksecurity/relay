--Title: Dark Relay
--Version: Ver. 2.11
--Author: Darkrising (minecraft name djhannz)
--Platform: ComputerCraft Lua Virtual Machine
--
-- Global variables
x, y = term.getSize()
PrgName = "relay"
-- functions
AutoUpdate = true
function GetPBfile(PBCode, uPath)
  local PBfile = http.get("http://pastebin.com/raw.php?i="..textutils.urlEncode(PBCode))
  if PBfile then
  	local PBfileToWrite = PBfile.readAll()
	  PBfile.close()
		  
	  local file = fs.open( uPath, "w" )
  	file.write(PBfileToWrite)
	  file.close()
  end
end
function CheckForUpdate(SPrgram, PbinCode)
term.clear()
term.setCursorPos(1,1)
local TVerDB_C = {}
  if ((http) and (AutoUpdate == true)) then
    if fs.exists("VerDB_C") == true then
      dofile("VerDB_C")
      for i = 1, #TVerDB do
        table.insert(TVerDB_C, TVerDB[i])
      end
      GetPBfile("mTbGjcVB", "VerDB_L")
      dofile("VerDB_L")
      if TVerDB[SPrgram] > TVerDB_C[SPrgram] then
        GetPBfile(PbinCode, PrgName.."_new")
        if fs.exists(PrgName.."_new") == true then
          fs.delete(PrgName)
          fs.move(PrgName.."_new", PrgName)       
          fs.delete("VerDB_C")
          fs.move("VerDB_L", "VerDB_C")         
          print("Update Complete")
          sleep(1)
          os.reboot()
        else
          print("Error downloading Update")
          sleep(1)
          return
        end
      else
        fs.delete("VerDB_L")
      end
    else
      -- Assume this version is the latest version
      GetPBfile("mTbGjcVB", "VerDB_C")
      os.reboot()
    end
  else
    print("Can't Check for updates, http is disabled.")
    sleep(0.5)
  end
end
function findModem() -- finds and opens attached modem
  for _,s in ipairs(rs.getSides()) do
    if peripheral.isPresent(s) and peripheral.getType(s) == "modem" then
      rednet.open(s)
      return true
    end
  end
  return false
end
-- Screen related functions
function screenwrite(text, line, nextline)
  local l = string.len(text)
  local nx = (x/2 - l/2)
  term.setCursorPos(nx,line)
  term.write(text)
  if nextline then
    term.setCursorPos(1, nextline)
  end
end
function lineacross(text, line, nextline)
  term.setCursorPos(1,line)
  for i=1,x do
    term.setCursorPos(i,line)
    term.write(text)
  end
  
  if nextline then
    term.setCursorPos(1, nextline)
  end
end
function Header(text)
  lineacross("-", 1)
  screenwrite(text, 2)
  lineacross("-", 3, 4)
end
-- main program
function relay()
term.clear()
term.setCursorPos(1,1)
print("Running relay.")
  while true do
    T, S, M = os.pullEvent("rednet_message")
    print("PC "..S.." Message Relayed.")     
    rednet.send(server, M)
    os.startTimer(4)
    T2, S2, M2 = os.pullEvent()
    if (T2 == "timer") then
      print("No response from server!")
    else
      if (S2 == server) then
        print("Server "..S2..": Responded")   
        rednet.send(S, M2)
      end
    end
  end
end

if not findModem() then print("Please attach Modem") return exit end -- checks for modem
CheckForUpdate(2, "8XqzYtnW")
if fs.exists("DarkR_conf") == false then
  term.clear()
  term.setCursorPos(1,1)
  Header("Dark Relay Setup")
  write("Please type the server / relay id: ")
  ServerID = io.read()
  local file = io.open("DarkR_conf","w")
  file:write("server = "..ServerID)
  file:close()
  print("\nsetup complete! Restarting...")
  sleep(1.5)
  os.reboot()
else
  dofile("DarkR_conf")
  relay()
end