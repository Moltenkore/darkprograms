--Title: Dark Card Generator
--Version: Ver. 2.12
--Author: Darkrising (minecraft name djhannz)
--Platform: ComputerCraft Lua Virtual Machine
--
term.clear()
term.setCursorPos(1,1)
PrgName = "cardgen"
x, y = term.getSize()
AutoUpdate = true
function GetPBfile(PBCode, uPath)
  local PBfile = http.get("http://pastebin.com/raw.php?i="..textutils.urlEncode(PBCode))
  if PBfile then
  	local PBfileToWrite = PBfile.readAll()
	  PBfile.close()
		  
	  local file = fs.open( uPath, "w" )
  	file.write(PBfileToWrite)
	  file.close()
  end
end
function CheckForUpdate(SPrgram, PbinCode)
term.clear()
term.setCursorPos(1,1)
local TVerDB_C = {}
  if ((http) and (AutoUpdate == true)) then
    if fs.exists("VerDB_C") == true then
      dofile("VerDB_C")
      for i = 1, #TVerDB do
        table.insert(TVerDB_C, TVerDB[i])
      end
      GetPBfile("mTbGjcVB", "VerDB_L")
      dofile("VerDB_L")
      if TVerDB[SPrgram] > TVerDB_C[SPrgram] then
        GetPBfile(PbinCode, PrgName.."_new")
        if fs.exists(PrgName.."_new") == true then
          fs.delete(PrgName)
          fs.move(PrgName.."_new", PrgName)       
          fs.delete("VerDB_C")
          fs.move("VerDB_L", "VerDB_C")         
          print("Update Complete")
          sleep(1)
          os.reboot()
        else
          print("Error downloading Update")
          sleep(1)
          return
        end
      else
        fs.delete("VerDB_L")
      end
    else
      -- Assume this version is the latest version
      GetPBfile("mTbGjcVB", "VerDB_C")
      os.reboot()
    end
  else
    print("Can't Check for updates, http is disabled.")
    sleep(0.5)
  end
end
function LOG(Text)
  local Time = textutils.formatTime(os.time(), true)
  local Log
  Log = fs.open("Dark_dglog", "a")
  Log.writeLine("ID:"..ID.." "..Time..Text)
  Log.close()
  print(Text)
end
function findModem() -- finds and opens attached modem
  for _,s in ipairs(rs.getSides()) do
    if peripheral.isPresent(s) and peripheral.getType(s) == "modem" then
      rednet.open(s)
      return true
    end
  end
  return false
end
function screenwrite(text, line, nextline)
  local l = string.len(text)
  local nx = (x/2 - l/2)
  term.setCursorPos(nx,line)
  term.write(text)
  if nextline then
    term.setCursorPos(1, nextline)
  end
end
function lineacross(text, line, nextline)
  term.setCursorPos(1,line)
  for i=1,x do
    term.setCursorPos(i,line)
    term.write(text)
  end
  
  if nextline then
    term.setCursorPos(1, nextline)
  end
end
function Header(text)
  lineacross("-", 1)
  screenwrite(text, 2)
  lineacross("-", 3, 4)
end
if fs.exists("DarkDG_conf") == false then
  term.clear()
  term.setCursorPos(1,1)
  Header("Dark Card Generator Setup")
  write("Please type the server / relay id: ")
  server = io.read()
  
  local file = io.open("DarkDG_conf","w")
  file:write("server = "..server)
  file:close()
  
  print("\nsetup complete! Restarting...")
  sleep(1.5)
  os.reboot()
  dofile("DarkDG_conf")
else
  dofile("DarkDG_conf")
end

CheckForUpdate(4, "Qu1rK82n")
term.clear()
term.setCursorPos(1,1)
if not findModem() then print("Please attach Modem") return exit end -- checks for modem
print("running cardgen.")

while true do
  event, DiskSide = os.pullEvent("disk")
  ID = tostring(disk.getDiskID(DiskSide)) 
  rednet.send(server, "QUERY#"..ID)
  S, M = rednet.receive(2)
  
  if M == "#DENIED#" then
    rednet.send(server, "ADDID#"..ID)
    LOG("ID Added")
  elseif M == "#GRANTED#" then
    rednet.send(server, "DELETEID#"..ID)
    LOG("ID Deleted")
  else
    LOG("No response from server.")
  end  
  disk.eject(DiskSide) 
end