--Title: Dark Card Generator
Version = 3.1
--Author: Darkrising (minecraft name djhannz)
--Platform: ComputerCraft Lua Virtual Machine
AutoUpdate = true
if fs.exists("dark") == false then -- load darkAPI
  print("Missing DarkAPI")
  sleep(2)
  print("Attempting to download...")
  getGit = http.get("https://github.com/darkrising/darkprograms/raw/darkprograms/darksecurity/dark")
  getGit = getGit.readAll()
  file = fs.open("dark", "w")
  file.write(getGit)
  file.close()
  os.reboot()
else
  os.loadAPI("dark")
end
function Header(text)
  dark.printL("-", 1)
  dark.printC(text, 2)
  dark.printL("-", 3, 4)
end
if fs.exists("DarkDG_conf") == false then
  term.clear()
  term.setCursorPos(1,1)
  Header("Dark Card Generator Setup")
  write("Please type the server / relay id: ")
  server = io.read()
  
  local file = io.open("DarkDG_conf","w")
  file:write("server = "..server)
  file:close()
  
  print("\nsetup complete! Restarting...")
  sleep(1.5)
  os.reboot()
  dofile("DarkDG_conf")
else
  dofile("DarkDG_conf")
end
term.clear() term.setCursorPos(1,1)
S = dark.findPeripheral("modem")
if S == false then
  print("Please attach Modem") 
  return exit
else
  rednet.open(S)  
end
if AutoUpdate == true then 
  if ((dark.gitUpdate("cardgen", shell.getRunningProgram(), Version) == true) or (dark.gitUpdate("dark", "dark", dark.DARKversion) == true)) then
    os.reboot()
  end
end
print("running cardgen.")
while true do
  event, DiskSide = os.pullEvent("disk")
  ID = tostring(disk.getDiskID(DiskSide)) 
  rednet.send(server, "QUERY#"..ID)
  S, M = rednet.receive(2)
  
  if M == "#DENIED#" then
    rednet.send(server, "ADDID#"..ID)
    print("ID Added")
  elseif M == "#GRANTED#" then
    rednet.send(server, "DELETEID#"..ID)
    print("ID Deleted")
  else
    print("No response from server.")
  end  
  disk.eject(DiskSide) 
end